<!doctype html>
<html>
  <head>
    <title>EMA Country Representative map</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://openlayers.org/en/v4.2.0/css/ol.css" type="text/css">
    <!-- <script type="text/javascript" src="./src/node_modules/proj4/dist/proj4.js"></script> -->

  </head>
  <body>
    <style>
    #map{
      width: 100%;
      height: 100%;
    }
    #popup {
    /* width: auto; */
    /* height: auto; */
    /* max-width: 50px; */
    /*border-radius: 10px;*/
    background-color: transparent;
    /*border-style: solid;*/

    }
    #popup-content{
      position: absolute;
      bottom: 0;
      width: 200px;
      /* height: auto; */
      border-radius: 10px;
      font-family: 'Verdana';
      text-align: center;
      padding: 5px 5px;
      border-style:ridge;
      border-width: 1px;
      border-color: rgba(0,102,204,1);
      background-color: rgba(255,255,255,.9);
      /*background-color: transparent;*/

     }

    .close-thik:before {
      content: 'âœ–'; /* UTF-8 symbol */
    }
    </style>
    <div id="information"></div>
    <div id="map" class="map"><div id="popup">
      <div id="popup-content"></div>
    </div>
    <script src="https://openlayers.org/en/v4.2.0/build/ol.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script>
    // let epsg54030 = proj4.defs('ROBISON','+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs');
    //let epsg54030 = 'PROJCS["World_Robinson",GEOGCS["GCS_WGS_1984",DATUM["WGS_1984",SPHEROID["WGS_1984",6378137,298.257223563]],PRIMEM["Greenwich",0],UNIT["Degree",0.017453292519943295]],PROJECTION["Robinson"],PARAMETER["False_Easting",0],PARAMETER["False_Northing",0],PARAMETER["Central_Meridian",0],UNIT["Meter",1],AUTHORITY["EPSG","54030"]]';

    var ema_CRs = (function () {
       var json = null;
       $.ajax({
           'async': false,
           'global': false,
           'url': "https://www.googleapis.com/fusiontables/v2/query?sql=SELECT * FROM 1971tqNea9guurOaf8YVTZKohW1KYXmoRmx1QoGzQ&key=AIzaSyAwhBgKGTcHqC5Zd3uVKNhGU4A0ty4Xd4o",
           'dataType': "json",
           'success': function (data) {
               json = data;
           }
       });
       return json;
    })();
// adding columns from fusion tables
   var country = [];
   var iso_code = [];
   var names = [];
   var lastnames = [];
   var emails = [];

  for (var i = 0; i < ema_CRs.rows.length; i++) {
    country.push(ema_CRs.rows[i][0]);
      iso_code.push(ema_CRs.rows[i][1]);
        names.push(ema_CRs.rows[i][2]);
          lastnames.push(ema_CRs.rows[i][3]);
            emails.push(ema_CRs.rows[i][4]);
  }

  var ema_data = {
    state: country,
    iso: iso_code,
    firstname: names,
    surname: lastnames,
    email: emails
  }
  var countriesSource = new ol.source.Vector({
    url: 'https://raw.githubusercontent.com/geomundus/EMA_CRs/master/countries.geojson',
    format: new ol.format.GeoJSON()
  });

  var countries = new ol.layer.Vector({
    id: 'country',
    source: countriesSource
    });
  
  let colorList = ["yellow","darkgreen","lightblue","lightyellow","darkolivegreen","bisque","greenyellow","purple","darkkhaki","lightsalmon","lawngreen", "aliceblue","coral"];
  let color;
  let Fill = function (feature){
      
    if (feature.get('chapter')==="South Asian"){
      color = colorList[0];
    }else if (feature.get('chapter')==="African") {
      color = colorList[1];
    }else if(feature.get('chapter')==='European'){
      color = colorList[2];
    }else if(feature.get('chapter')==="Asian"){
      color = colorList[3];
    }else if (feature.get('chapter')==="Middle East"){
      color = colorList[4];
    }else if (feature.get('chapter')==="Eurasian"){
      color = colorList[5];
    }else if(feature.get('chapter')==="Chinese"){
      color = colorList[6];
    }else if(feature.get('chapter')==="Far East"){
      color = colorList[7];
    }else if (feature.get('chapter')==="Indian"){
      color = colorList[8];
    }else if (feature.get('chapter')==="Latin American"){
      color = colorList[9];
    }else if (feature.get('chapter')==="North American"){
      color = colorList[10];
    }else if (feature.get('chapter')==="South-East Asian"){
      color = colorList[11];
   }else if (feature.get('chapter')=== "Oceania"){
     color = colorList[12];
   }
   return new ol.style.Style({ fill: new ol.style.Fill({ color: color})});
  }

  var chapters = new ol.layer.Vector({
    id: 'chapters',
    source: countriesSource,
    style: Fill,
    opacity: .5
    });


    // var center = proj4(epsg54030,([0,30])); 
    let center = ol.proj.transform([0,30],'EPSG:4326','EPSG:3857');
    // var extent = ol.proj.transform([-180,-90,180,90],'EPSG:4326','EPSG:3857');
    // let extent = ol.proj.transform([-20026376.39, -20048966.10, 20026376.39, 20048966.10], 'EPSG:4326','EPSG:3857');
    let extent = ol.proj.transformExtent([-180,-90,180,90], 'EPSG:4326','EPSG:3857');
    var view = new ol.View({
      center: center,
      zoom: 2.5,
      minZoom: 2,
      maxZoom: 8,
      extent: extent
    });

    var stamen_labels = new ol.layer.Tile({
      projection: 'EPSG:3857',
      source: new ol.source.Stamen({
        layer: 'toner-labels'
      })
    });
    var stamen_water = new ol.layer.Tile({
      projection: '3587',
      source: new ol.source.Stamen({
        layer: 'watercolor'
      })
    });

    var map = new ol.Map ({
      target: 'map',
      layers: [countries, chapters, stamen_labels],
      view: view,
    });

    var baseTextstyle = {
      font: '12px Calibri,sans-serif',
      textAlign: 'center',
      offsetY: -15,
      fill: new ol.style.Fill({
        color:[0,0,0,1]
      }),
      stroke: new ol.style.Stroke({
        color: [255,255,0.5],
        width: 4
      })
    };

    var highlightStyle = new ol.style.Style({
      stroke: new ol.style.Stroke({
        color: [255,0,0,0.6],
        width: 2
      }),
      fill: new ol.style.Fill({
        color: [255,0,0,0.2]
      }),
      zIndex: 1
    });

// style function for making up countries and interaction
    function styleFunction(feature,resolution){
      var style;
      var geom = feature.getGeometry();
      if (geom.getType() == 'Point') {
        var text = feature.get('text');
        baseTextstyle.text = text;
        var isoCode = feature.get('isoCode');
        style = new ol.style.Style({
          text: new ol.style.Text(baseTextstyle),
          image: new ol.style.Icon({
            src: 'https://www.geognos.com/api/en/countries/flag/' + isoCode + '.png'
          }),
          zIndex: 2
        });
      } else {
        style = highlightStyle;
      }
      return [style];
    }
    var featureOverlay = new ol.Overlay ({
      map: map,
      style: styleFunction
    });

    var popup = new ol.Overlay({
       element: document.getElementById('popup')
     });

   map.addOverlay(popup);

// styling countries on hover
   var selectInteraction = new ol.interaction.Select({
     condition: ol.events.condition.pointerMove,
     toggleCondition: ol.events.condition.shiftKeyOnly,
     layers: function (layer) {
       return layer.get('id') == 'country';
     },
     style: styleFunction
   });

   map.addOverlay(popup);


    var container = document.getElementById('popup-content');
    var displayFeatureInfo = function(pixel, coordinate) {
      var features = [];
      map.forEachFeatureAtPixel(pixel, function(feature, layer) {
        features.push(feature);
        // console.log(feature.get('chapter').length);
      if (features.length > 0) {
        var info = [];
        for (var i = 0, ii = features.length; i < ii; ++i) {
          //info.push(features[i].get('name'));
          var index = ema_data.iso.indexOf(features[i].get('iso_a2'));

            var inf = 'http://www.geognos.com/api/en/countries/flag/' + ema_data.iso[index] + '.png';
            var src = '<img src="'+inf+'" alt=" " width = 56 height=32>';
        }
        if (!ema_data.firstname[index]){
          ema_data.firstname[index]='Vacant';
        } else if (!ema_data.surname[index]){
          ema_data.surname[index]='position';
        } else if(!ema_data.email[index]){
          ema_data.email[index]='&nbsp;';
        }
        container.innerHTML = src +" "+ feature.get("name") + '<br><b>' + ema_data.firstname[index] + " " + ema_data.surname[index] + '</b><br>' + ema_data.email[index] + "<br>Chapter: " + feature.get("chapter");
        popup.setPosition(coordinate);
        $('#popup').show();
      } else {
        container.innerHTML = '&nbsp;';
        $('#popup').hide();
      }
      });
    };

    var a = map.on('pointermove', function(evt) {
      var coordinate = evt.coordinate;
      displayFeatureInfo(evt.pixel, coordinate);
    });
    map.on('click', function(evt) {
      map.un('pointermove');
      var coordinate = evt.coordinate;
      popup.setPosition(coordinate);
      $('#popup').toggle();

    });
    // map.on('pointermove', function (e){

      // featureOverlay.getFeatures().clear();
      // var coordinate = e.coordinate;
      // var pixel = e.pixel;

      // map.forEachFeatureAtPixel(pixel,function(feature,layer){
      //   if (!layer) {
      //     return;
      //   }
      //   var geometry = feature.getGeometry();
      //   var point;
      //   switch (geometry.getType()) {
      //     case 'MultiPolygon':
      //     var poly = geometry.getPolygons().reduce(function(left,right){
      //       return left.getArea() > right.getArea() ? left : right;
      //     });
      //     point = poly.getInteriorPoint().getCoordinates();
      //     break;
      //     case 'Polygon':
      //       point = geometry.getInteriorPoint().getCoordinates();
      //       break;
      //     default:
      //       point = geometry.getClosestPoint(coordinate);
      //     }
      //     var index = ema_data.iso.indexOf(feature.get('iso_a2'));
      //
      //     popup.setPosition(point);
      //     popup.innerHTML = 'sdsdfsdfsd';


          // textFeature = new ol.Feature ({
          //   geometry: new ol.geom.Point(point),
          //   // text: feature.get('name'),
          //   // text: ema_CRs.rows.indexOf(feature.get('iso_a2')),
          //   text: ema_data.firstname[index] + " " + ema_data.surname[index],
          //   isoCode: feature.get('iso_a2')
          //
          //
          // });
          //
          // featureOverlay.addFeature(textFeature);
          // featureOverlay.addFeature(feature);
        // });
      // });
      map.getInteractions().extend([selectInteraction]);
    </script>
  </body>
</html>
